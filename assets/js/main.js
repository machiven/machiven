const translations = {
  en: {
    navServices: 'Services',
    navShop: 'Shop',
    navRepairs: 'Repairs',
    navAbout: 'About',
    navContact: 'Contact',
    ctaQuote: 'Get a quote',
    heroEyebrow: 'Industrial machinery solutions',
    heroTitle: 'Buy, source, and repair heavy equipment with confidence.',
    heroCopy: 'We supply in-stock machinery, find hard-to-source equipment, and provide expert repair services for industrial operations.',
    ctaQuoteMain: 'Request a quote',
    ctaWhatsApp: 'Chat on WhatsApp',
    servicesTitle: 'What we do',
    servicesCopy: 'Complete industrial machinery solutions tailored to your needs.',
    service1Title: 'Buy Existing Machinery',
    service1Copy: 'Browse our inventory of inspected, in-stock industrial equipment ready for immediate delivery.',
    service1Link: 'View shop ‚Üí',
    service2Title: 'Find & Source Equipment',
    service2Copy: 'Need a specific machine or part? We source hard-to-find equipment with full inspection reports.',
    service2Link: 'Request sourcing ‚Üí',
    service3Title: 'Repair & Maintenance',
    service3Copy: 'On-site and remote repair services, parts sourcing, and preventive maintenance for your fleet.',
    service3Link: 'Learn more ‚Üí',
    shopTitle: 'In-stock equipment',
    shopCopy: 'Inspected machinery available for immediate purchase and delivery.',
    badgeStock: 'In stock',
    badgeSoon: 'Arriving soon',
    product1Desc: 'Precision machining center with tool changer, fully inspected and leveled.',
    product2Desc: 'High-tonnage press brake with programmable back gauge and safety systems.',
    product3Desc: 'Heavy-duty forklift with load certification and operator training included.',
    productQuote: 'Request quote',
    repairsTitle: 'Repair & maintenance services',
    repairsCopy: 'Keep your equipment running with expert technical support.',
    repair1: 'On-site repairs & diagnostics',
    repair1Desc: 'Technicians dispatch to your facility for urgent breakdowns and scheduled maintenance.',
    repair2: 'Parts sourcing & replacement',
    repair2Desc: 'We stock critical consumables and source OEM/aftermarket parts for fast turnaround.',
    repair3: 'Preventive maintenance plans',
    repair3Desc: 'Scheduled inspections and service contracts to minimize downtime and extend equipment life.',
    repairCta: 'Request repair quote',
    aboutEyebrow: 'About Machiven LLC',
    aboutTitle: 'Field engineers who understand uptime.',
    aboutCopy: 'We blend procurement, technical inspection, and logistics so you get machinery that performs. From first call to installation and beyond, you work directly with engineers and technicians.',
    metaYears: 'Years in heavy industry',
    metaClients: 'Clients across United States',
    login: 'Log in',
    logout: 'Log out',
    authTitle: 'Sign in',
    authEmail: 'Email',
    authUsername: 'Username',
    authPassword: 'Password',
    authSignIn: 'Sign in',
    adminTitle: 'Admin products',
    adminDesc: 'Manage shop items.',
    adminNoAccess: 'Restricted area. Log in as admin.',
    adminCreate: 'Create product',
    productName: 'Name',
    productDesc: 'Description',
    productPrice: 'Price',
    productStatus: 'Status',
    productImageUrl: 'Image URL',
    productSlug: 'Slug',
    productOrder: 'Order',
    addressLabel: 'Contact us',
    contactTitle: 'Ready to get started?',
    contactCopy: 'Request a quote for purchase, sourcing, or repairs.',
    contactQuote: 'Get a quote',
    contactChat: 'Chat on WhatsApp',
    contactEmail: 'Email admin@machiven.com',
    footerCopy: 'Machiven LLC. Reliable machinery, expert service.',
    modalTitle: 'Request a quote',
    modalSubtitle: "Fill out the form and we'll get back to you within 24 hours.",
    formType: 'Type of request *',
    formTypeSelect: 'Select type...',
    formTypeExisting: 'Existing product (from shop)',
    formTypeFind: 'Find & source product',
    formTypeRepair: 'Repair service',
    formFirstName: 'First name *',
    formLastName: 'Last name *',
    formEmail: 'Email *',
    formPhone: 'Phone *',
    formCompany: 'Company name (optional)',
    formProduct: 'Product of interest',
    formMessage: 'Message / Specifications *',
    formSubmit: 'Send quote request',
    formFirstNamePh: 'John',
    formLastNamePh: 'Smith',
    formEmailPh: 'john@company.com',
    formPhonePh: '+1 305...',
    formCompanyPh: 'Company name',
    formProductPh: 'Product or part details',
    formMessagePh: 'Tell us about your needs, specifications, or timeline...'
  },
  es: {
    navServices: 'Servicios',
    navShop: 'Tienda',
    navRepairs: 'Reparaciones',
    navAbout: 'Nosotros',
    navContact: 'Contacto',
    ctaQuote: 'Solicitar cotizaci√≥n',
    heroEyebrow: 'Soluciones de maquinaria industrial',
    heroTitle: 'Compra, busca y repara equipos pesados con confianza.',
    heroCopy: 'Suministramos maquinaria en stock, encontramos equipos dif√≠ciles de conseguir y ofrecemos servicios expertos de reparaci√≥n para operaciones industriales.',
    ctaQuoteMain: 'Solicitar cotizaci√≥n',
    ctaWhatsApp: 'Chatea en WhatsApp',
    servicesTitle: 'Qu√© hacemos',
    servicesCopy: 'Soluciones completas de maquinaria industrial adaptadas a tus necesidades.',
    service1Title: 'Compra maquinaria existente',
    service1Copy: 'Explora nuestro inventario de equipos industriales inspeccionados y listos para entrega inmediata.',
    service1Link: 'Ver tienda ‚Üí',
    service2Title: 'Busca y consigue equipos',
    service2Copy: '¬øNecesitas una m√°quina o pieza espec√≠fica? Conseguimos equipos dif√≠ciles de encontrar con reportes de inspecci√≥n completos.',
    service2Link: 'Solicitar b√∫squeda ‚Üí',
    service3Title: 'Reparaci√≥n y mantenimiento',
    service3Copy: 'Servicios de reparaci√≥n en sitio y remotos, b√∫squeda de piezas y mantenimiento preventivo para tu flota.',
    service3Link: 'Saber m√°s ‚Üí',
    shopTitle: 'Equipos en stock',
    shopCopy: 'Maquinaria inspeccionada disponible para compra y entrega inmediata.',
    badgeStock: 'En stock',
    badgeSoon: 'Pr√≥ximamente',
    product1Desc: 'Centro de mecanizado de precisi√≥n con cambiador de herramientas, totalmente inspeccionado y nivelado.',
    product2Desc: 'Prensa plegadora de alto tonelaje con tope trasero programable y sistemas de seguridad.',
    product3Desc: 'Montacargas pesado con certificaci√≥n de carga y capacitaci√≥n de operadores incluida.',
    productQuote: 'Solicitar cotizaci√≥n',
    repairsTitle: 'Servicios de reparaci√≥n y mantenimiento',
    repairsCopy: 'Mant√©n tu equipo funcionando con soporte t√©cnico experto.',
    repair1: 'Reparaciones y diagn√≥sticos en sitio',
    repair1Desc: 'T√©cnicos se desplazan a tu instalaci√≥n para aver√≠as urgentes y mantenimiento programado.',
    repair2: 'B√∫squeda y reemplazo de piezas',
    repair2Desc: 'Mantenemos consumibles cr√≠ticos y conseguimos piezas OEM/aftermarket para entrega r√°pida.',
    repair3: 'Planes de mantenimiento preventivo',
    repair3Desc: 'Inspecciones programadas y contratos de servicio para minimizar tiempo de inactividad y extender la vida del equipo.',
    repairCta: 'Solicitar cotizaci√≥n de reparaci√≥n',
    aboutEyebrow: 'Acerca de Machiven LLC',
    aboutTitle: 'Ingenieros de campo que entienden el uptime.',
    aboutCopy: 'Combinamos procura, inspecci√≥n t√©cnica y log√≠stica para que recibas maquinaria que funciona. Desde la primera llamada hasta la instalaci√≥n y m√°s all√°, trabajas directamente con ingenieros y t√©cnicos.',
    metaYears: 'A√±os en la industria',
    metaClients: 'Clientes en Estados Unidos',
    login: 'Iniciar sesi√≥n',
    logout: 'Cerrar sesi√≥n',
    authTitle: 'Iniciar sesi√≥n',
    authEmail: 'Correo',
    authUsername: 'Usuario',
    authPassword: 'Contrase√±a',
    authSignIn: 'Entrar',
    adminTitle: 'Admin productos',
    adminDesc: 'Gestiona art√≠culos de la tienda.',
    adminNoAccess: 'Zona restringida. Inicia sesi√≥n como admin.',
    adminCreate: 'Crear producto',
    productName: 'Nombre',
    productDesc: 'Descripci√≥n',
    productPrice: 'Precio',
    productStatus: 'Estado',
    productImageUrl: 'URL de imagen',
    productSlug: 'Slug',
    productOrder: 'Orden',
    addressLabel: 'Cont√°ctanos',
    contactTitle: '¬øListo para comenzar?',
    contactCopy: 'Solicita una cotizaci√≥n para compra, b√∫squeda o reparaciones.',
    contactQuote: 'Solicitar cotizaci√≥n',
    contactChat: 'Chatea en WhatsApp',
    contactEmail: 'Env√≠a correo a admin@machiven.com',
    footerCopy: 'Machiven LLC. Maquinaria confiable, servicio experto.',
    modalTitle: 'Solicitar cotizaci√≥n',
    modalSubtitle: 'Completa el formulario y te responderemos en 24 horas.',
    formType: 'Tipo de solicitud *',
    formTypeSelect: 'Selecciona tipo...',
    formTypeExisting: 'Producto existente (de la tienda)',
    formTypeFind: 'Buscar y conseguir producto',
    formTypeRepair: 'Servicio de reparaci√≥n',
    formFirstName: 'Nombre *',
    formLastName: 'Apellido *',
    formEmail: 'Correo *',
    formPhone: 'Tel√©fono *',
    formCompany: 'Nombre de empresa (opcional)',
    formProduct: 'Producto de inter√©s',
    formMessage: 'Mensaje / Especificaciones *',
    formSubmit: 'Enviar solicitud',
    formFirstNamePh: 'Juan',
    formLastNamePh: 'P√©rez',
    formEmailPh: 'juan@empresa.com',
    formPhonePh: '+52...',
    formCompanyPh: 'Nombre de la empresa',
    formProductPh: 'Detalles del producto o pieza',
    formMessagePh: 'Cu√©ntanos sobre tus necesidades, especificaciones o plazos...'
  }
};

const langButtons = document.querySelectorAll('.lang-switch__btn');
let currentLang = 'en';

function applyTranslations(lang) {
  const dict = translations[lang];
  if (!dict) return;

  document.documentElement.lang = lang;
  currentLang = lang;

  document.querySelectorAll('[data-i18n]').forEach(el => {
    const key = el.dataset.i18n;
    if (dict[key]) el.textContent = dict[key];
  });

  document.querySelectorAll('[data-i18n-placeholder]').forEach(el => {
    const key = el.dataset.i18nPlaceholder;
    if (dict[key]) el.setAttribute('placeholder', dict[key]);
  });

  langButtons.forEach(btn => btn.classList.toggle('is-active', btn.dataset.lang === lang));
}

langButtons.forEach(btn => {
  btn.addEventListener('click', () => applyTranslations(btn.dataset.lang));
});

applyTranslations('en');

// Supabase init
const SUPABASE_URL = 'https://sggwlqpahbozwxbgyvnz.supabase.co';
const SUPABASE_PUBLIC_KEY = 'sb_publishable_kb03aBmPjoxEHWShPjoV4Q_Nic865LA';
const SUPABASE_BUCKET = 'product-images';
// Single allowed admin user config
const ALLOWED_USERNAME = 'rosanacsf';
const ALLOWED_EMAIL = 'admin@machiven.com';
const ALLOWED_PASSWORD = '7151874';
const sb = window.supabase?.createClient ? window.supabase.createClient(SUPABASE_URL, SUPABASE_PUBLIC_KEY) : null;

// Auth UI elements
const authModal = document.getElementById('authModal');
const authForm = document.getElementById('authForm');
const btnLogin = document.getElementById('btnLogin');
const btnLogout = document.getElementById('btnLogout');
const authStatus = document.getElementById('authStatus');
const adminTabLink = document.getElementById('adminTabLink');
const adminSection = document.getElementById('admin');
const adminGate = document.getElementById('adminGate');
const adminPanel = document.getElementById('adminPanel');
// const btnSignUp = document.getElementById('btnSignUp'); // removed from UI

function openAuth() {
  if (!authModal) return;
  authModal.style.display = 'block';
  authModal.classList.add('is-open');
  document.body.style.overflow = 'hidden';
}

function closeAuth() {
  if (!authModal) return;
  authModal.classList.remove('is-open');
  authModal.style.display = 'none';
  document.body.style.overflow = '';
  authForm && authForm.reset();
}

document.querySelectorAll('[data-open-auth]').forEach(el => el.addEventListener('click', openAuth));
document.querySelectorAll('[data-close-auth]').forEach(el => el.addEventListener('click', closeAuth));

async function refreshSessionUI() {
  if (!sb) return;
  const { data } = await sb.auth.getSession();
  const user = data?.session?.user || null;
  if (user) {
    btnLogin && (btnLogin.style.display = 'none');
    btnLogout && (btnLogout.style.display = 'inline-block');
    authStatus && (authStatus.style.display = 'inline');
    authStatus && (authStatus.textContent = user.email);
    adminTabLink && (adminTabLink.style.display = 'inline-block');
    adminSection && (adminSection.style.display = 'block');
    await gateAdmin(user);
  } else {
    btnLogin && (btnLogin.style.display = 'inline-block');
    btnLogout && (btnLogout.style.display = 'none');
    authStatus && (authStatus.style.display = 'none');
    authStatus && (authStatus.textContent = '');
    adminTabLink && (adminTabLink.style.display = 'none');
    adminSection && (adminSection.style.display = 'none');
  }
}

async function gateAdmin(user) {
  if (!sb || !user) return;
  const { data, error } = await sb.from('profiles').select('role').eq('id', user.id).single();
  if (error || !data || data.role !== 'admin') {
    adminGate && (adminGate.style.display = 'block');
    adminPanel && (adminPanel.style.display = 'none');
  } else {
    adminGate && (adminGate.style.display = 'none');
    adminPanel && (adminPanel.style.display = 'block');
    await loadProducts();
  }
}

sb.auth.onAuthStateChange((_event, _session) => {
  refreshSessionUI();
});
refreshSessionUI();

authForm && authForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!sb) return;
  const fd = new FormData(authForm);
  const username = (fd.get('username') || '').toString().trim().toLowerCase();
  const password = (fd.get('password') || '').toString();

  // Enforce single-user login
  if (username !== ALLOWED_USERNAME) {
    alert('Not authorized');
    return;
  }
  const email = ALLOWED_EMAIL; // hidden; mapped internally
  if (password !== ALLOWED_PASSWORD) {
    alert('Incorrect password');
    return;
  }
  const { error } = await sb.auth.signInWithPassword({ email, password });
  if (!error) {
    closeAuth();
    // Redirect to admin page if not already there
    if (!window.location.pathname.includes('admin')) {
      window.location.href = '/admin.html';
    }
  } else {
    alert(error.message);
  }
});

// Sign-up removed; only the authorized user can log in

btnLogout && btnLogout.addEventListener('click', async () => {
  if (!sb) return;
  await sb.auth.signOut();
  window.location.href = '/';
});

// Admin products CRUD
const productForm = document.getElementById('productForm');
const adminList = document.getElementById('adminProductsList');
const imageFileInput = document.getElementById('productImageFile');

async function loadProducts() {
  if (!sb) return;
  const { data, error } = await sb.from('products').select('*').order('sort_order', { ascending: true });
  if (error) {
    adminList && (adminList.textContent = error.message);
    return;
  }
  renderProducts(data || []);
}

function renderProducts(items) {
  if (!adminList) return;
  adminList.innerHTML = '';
  items.forEach(item => {
    const card = document.createElement('article');
    card.className = 'card card--border';
    card.innerHTML = `
      <div class="card__icon">üì¶</div>
      <h3>${item.name || ''}</h3>
      <p>${item.description || ''}</p>
      <p>${item.price != null ? '$' + item.price : ''} ${item.status || ''}</p>
      <div class="field-row">
        <button class="pill-button" data-action="edit" data-id="${item.id}">Edit</button>
        <button class="pill-button pill-button--ghost" data-action="delete" data-id="${item.id}">Delete</button>
      </div>
    `;
    adminList.appendChild(card);
  });

  adminList.querySelectorAll('button[data-action="delete"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const ok = confirm('Delete product?');
      if (!ok) return;
      const { error } = await sb.from('products').delete().eq('id', id);
      if (error) alert(error.message); else { loadProducts(); loadPublicProducts(); }
    });
  });

  adminList.querySelectorAll('button[data-action="edit"]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const id = btn.dataset.id;
      const { data, error } = await sb.from('products').select('*').eq('id', id).single();
      if (error) { alert(error.message); return; }
      fillForm(data);
      productForm.dataset.editId = id;
      document.querySelector('[data-i18n="adminCreate"]').textContent = translations[currentLang].adminUpdate || 'Update product';
    });
  });
}

function fillForm(item) {
  if (!productForm) return;
  productForm.name.value = item.name || '';
  productForm.price.value = item.price || '';
  productForm.description.value = item.description || '';
  productForm.status.value = item.status || 'in-stock';
  productForm.sort_order.value = item.sort_order || 0;
  productForm.image_url.value = item.image_url || '';
  productForm.slug.value = item.slug || '';
  
  // Update checkbox based on whether price exists
  const showPriceCheckbox = document.getElementById('showPriceCheckbox');
  const priceInput = document.getElementById('priceInput');
  if (showPriceCheckbox && priceInput) {
    showPriceCheckbox.checked = item.price != null;
    priceInput.disabled = !showPriceCheckbox.checked;
  }
}

// Handle price checkbox toggle
const showPriceCheckbox = document.getElementById('showPriceCheckbox');
const priceInput = document.getElementById('priceInput');
if (showPriceCheckbox && priceInput) {
  showPriceCheckbox.addEventListener('change', () => {
    priceInput.disabled = !showPriceCheckbox.checked;
    if (!showPriceCheckbox.checked) {
      priceInput.value = '';
    }
  });
}

productForm && productForm.addEventListener('submit', async (e) => {
  e.preventDefault();
  if (!sb) return;
  let imageUrl = productForm.image_url.value || null;

  // Handle optional image upload
  if (imageFileInput && imageFileInput.files && imageFileInput.files[0]) {
    const file = imageFileInput.files[0];
    const path = `uploads/${Date.now()}-${file.name}`;
    
    const { error: uploadError } = await sb.storage.from(SUPABASE_BUCKET).upload(path, file, { upsert: true });
    if (uploadError) {
      if (uploadError.message.includes('not found')) {
        alert(`El bucket "${SUPABASE_BUCKET}" no existe. Por favor cr√©alo en Supabase Dashboard: Storage > New Bucket > Nombre: "${SUPABASE_BUCKET}" > Public: Yes`);
      } else {
        alert(`No se pudo subir la imagen: ${uploadError.message}`);
      }
      return;
    }
    const { data: urlData } = sb.storage.from(SUPABASE_BUCKET).getPublicUrl(path);
    imageUrl = urlData?.publicUrl || imageUrl;
  }

  const payload = {
    name: productForm.name.value,
    price: showPriceCheckbox?.checked && productForm.price.value ? Number(productForm.price.value) : null,
    description: productForm.description.value || null,
    status: productForm.status.value || 'in-stock',
    sort_order: productForm.sort_order.value ? parseInt(productForm.sort_order.value, 10) : 0,
    image_url: imageUrl,
    slug: productForm.slug.value || null,
  };
  const editId = productForm.dataset.editId;
  let error;
  if (editId) {
    ({ error } = await sb.from('products').update(payload).eq('id', editId));
  } else {
    ({ error } = await sb.from('products').insert([payload]));
  }
  if (error) {
    alert(error.message);
  } else {
    productForm.reset();
    if (imageFileInput) imageFileInput.value = '';
    delete productForm.dataset.editId;
    document.querySelector('[data-i18n="adminCreate"]').textContent = translations[currentLang].adminCreate || 'Create product';
    loadProducts();
    loadPublicProducts(); // Refresh public shop too
  }
});

// Modal management
const modal = document.getElementById('quoteModal');
const openButtons = document.querySelectorAll('[data-open-quote]');
const closeButtons = document.querySelectorAll('[data-close-quote]');
const quoteForm = document.querySelector('[data-quote-form]');
const typeSelect = quoteForm ? quoteForm.querySelector('select[name="type"]') : null;
const productField = document.getElementById('productField');

function openModal(quoteType = '', product = '') {
  if (!modal || !quoteForm) return;
  modal.classList.add('is-open');
  document.body.style.overflow = 'hidden';
  
  if (quoteType && typeSelect) {
    typeSelect.value = quoteType === 'existing' ? 'existing-product' : quoteType === 'find' ? 'find-product' : 'repair';
    handleTypeChange();
  }
  
  if (product && productField) {
    const input = productField.querySelector('input[name="product"]');
    if (input) input.value = product;
  }
}

function closeModal() {
  if (!modal || !quoteForm) return;
  modal.classList.remove('is-open');
  document.body.style.overflow = '';
  quoteForm.reset();
  if (productField) productField.style.display = 'none';
}

function handleTypeChange() {
  if (!typeSelect || !productField) return;
  const type = typeSelect.value;
  if (type === 'existing-product') {
    productField.style.display = 'flex';
  } else {
    productField.style.display = 'none';
  }
}

// Attach quote modal handlers
openButtons.forEach(btn => {
  btn.addEventListener('click', () => {
    const quoteType = btn.dataset.quoteType || '';
    const product = btn.dataset.product || '';
    openModal(quoteType, product);
  });
});

closeButtons.forEach(btn => {
  btn.addEventListener('click', closeModal);
});

if (typeSelect) {
  typeSelect.addEventListener('change', handleTypeChange);
}

if (quoteForm && modal) {

  // Form submission -> generate professional PDF quote and open mailto
  quoteForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    if (!sb) {
      alert('No se pudo enviar. Intenta m√°s tarde.');
      return;
    }

    const formData = new FormData(quoteForm);
    const payload = {
      type: formData.get('type') || null,
      first_name: formData.get('firstName') || null,
      last_name: formData.get('lastName') || null,
      email: formData.get('email') || null,
      phone: formData.get('phone') || null,
      company: formData.get('company') || null,
      product: formData.get('product') || null,
      message: formData.get('message') || null,
      submitted_at: new Date().toISOString()
    };

    // Save to Supabase
    const { error } = await sb.from('quote_requests').insert([payload]);
    if (error) {
      alert(`No se pudo guardar: ${error.message}`);
      return;
    }

    // Send email via Edge Function (public, no auth header needed)
    try {
      const response = await fetch('https://sggwlqpahbozwxbgyvnz.supabase.co/functions/v1/send-quote-email', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      });

      const result = await response.json();

      if (!response.ok) {
        console.error('Email error:', result);
        alert(currentLang === 'en'
          ? 'The quote was saved but email sending failed. We will contact you shortly.'
          : 'La cotizaci√≥n se guard√≥ pero el email no se envi√≥. Nos pondremos en contacto pronto.');
      } else {
        const confirmationEmail = payload.email || 'your email';
        alert(currentLang === 'en'
          ? `Quote request submitted. Check ${confirmationEmail} for your confirmation.`
          : `Solicitud enviada. Revisa ${confirmationEmail} para tu confirmaci√≥n.`);
      }
    } catch (emailError) {
      console.error('Email send error:', emailError);
      alert(currentLang === 'en'
        ? 'The quote was saved but we could not send the email. Please try again or contact us directly.'
        : 'La cotizaci√≥n se guard√≥ pero no pudimos enviar el email. Por favor intenta de nuevo o cont√°ctanos.');
    }
    closeModal();
  });
}

// Public shop products load
const publicProductsGrid = document.getElementById('publicProductsGrid');

async function loadPublicProducts() {
  if (!sb || !publicProductsGrid) return;
  const { data, error } = await sb.from('products').select('*').order('sort_order', { ascending: true });
  if (error) {
    publicProductsGrid.innerHTML = '<p>Unable to load products.</p>';
    return;
  }
  renderPublicProducts(data || []);
}

function renderPublicProducts(items) {
  if (!publicProductsGrid) return;
  publicProductsGrid.innerHTML = '';
  if (items.length === 0) {
    publicProductsGrid.innerHTML = '<p>No products available.</p>';
    return;
  }
  items.forEach(item => {
    const badgeClass = item.status === 'soon' ? 'badge--soon' : 'badge--stock';
    const badgeKey = item.status === 'soon' ? 'badgeSoon' : 'badgeStock';
    const badgeText = translations[currentLang][badgeKey] || (item.status === 'soon' ? 'Arriving soon' : 'In stock');
    const priceText = item.price != null ? `$${Number(item.price).toLocaleString()}` : (currentLang === 'en' ? 'Request quote for pricing' : 'Solicitar cotizaci√≥n para precio');
    
    const card = document.createElement('article');
    card.className = 'product-card';
    card.innerHTML = `
      <div class="product-card__image">
        <img src="${item.image_url || 'https://images.unsplash.com/photo-1581091226825-a6a2a5aee158?auto=format&fit=crop&w=800&q=80'}" alt="${item.name || 'Product'}" loading="lazy">
        <span class="badge ${badgeClass}">${badgeText}</span>
      </div>
      <div class="product-card__content">
        <h3 class="product-card__title">${item.name || ''}</h3>
        <p class="product-card__meta">${priceText}</p>
        <p class="product-card__desc">${item.description || ''}</p>
        <button class="pill-button pill-button--full" data-open-quote data-quote-type="existing" data-product="${item.name || ''}" data-i18n="productQuote">${translations[currentLang].productQuote || 'Request quote'}</button>
      </div>
    `;
    publicProductsGrid.appendChild(card);
  });

  // Re-attach modal open handlers for new buttons
  publicProductsGrid.querySelectorAll('[data-open-quote]').forEach(btn => {
    btn.addEventListener('click', () => {
      const quoteType = btn.dataset.quoteType || '';
      const product = btn.dataset.product || '';
      openModal(quoteType, product);
    });
  });
}

if (sb) {
  loadPublicProducts();
}

// Smooth scrolling
const navLinks = document.querySelectorAll('.nav a, a[href^="#"]');
navLinks.forEach(link => {
  link.addEventListener('click', (e) => {
    const href = link.getAttribute('href');
    if (href && href.startsWith('#')) {
      e.preventDefault();
      const target = document.querySelector(href);
      if (target) target.scrollIntoView({ behavior: 'smooth' });
    }
  });
});
